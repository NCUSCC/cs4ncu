# PR é¢„è§ˆæ¸…ç†å·¥ä½œæµ
name: ğŸ§¹ æ¸…ç† PR é¢„è§ˆç¯å¢ƒ

# è§¦å‘æ¡ä»¶ï¼šPR å…³é—­æˆ–åˆå¹¶æ—¶
on:
  pull_request:
    types: [closed]
    branches: [main]

# æƒé™é…ç½®
permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-preview:
    name: ğŸ—‘ï¸ æ¸…ç†é¢„è§ˆç¯å¢ƒ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡º gh-pages åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: æ¸…ç† PR é¢„è§ˆèµ„æº
        id: cleanup
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç† PR #${{ github.event.pull_request.number }} çš„é¢„è§ˆç¯å¢ƒ..."
          
          pr_preview_dir="pr-preview/pr-${{ github.event.pull_request.number }}"
          
          if [[ -d "$pr_preview_dir" ]]; then
            echo "ğŸ—‘ï¸  åˆ é™¤é¢„è§ˆç›®å½•: $pr_preview_dir"
            rm -rf "$pr_preview_dir"
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºç©ºçš„ pr-preview ç›®å½•ï¼Œå¦‚æœæ˜¯åˆ™åˆ é™¤
            if [[ -d "pr-preview" ]] && [[ -z "$(ls -A pr-preview)" ]]; then
              echo "ğŸ—‚ï¸  åˆ é™¤ç©ºçš„ pr-preview ç›®å½•"
              rmdir pr-preview
            fi
            
            echo "cleanup-performed=true" >> $GITHUB_OUTPUT
            echo "âœ… é¢„è§ˆç¯å¢ƒæ¸…ç†å®Œæˆ"
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ° PR #${{ github.event.pull_request.number }} çš„é¢„è§ˆç¯å¢ƒ"
            echo "cleanup-performed=false" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤æ¸…ç†å˜æ›´
        if: steps.cleanup.outputs.cleanup-performed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add -A
          git commit -m "ğŸ§¹ æ¸…ç† PR #${{ github.event.pull_request.number }} é¢„è§ˆç¯å¢ƒ
          
          - åˆ é™¤é¢„è§ˆç›®å½•: pr-preview/pr-${{ github.event.pull_request.number }}
          - è§¦å‘åŸå› : PR å…³é—­/åˆå¹¶
          - æ¸…ç†æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          git push
          
          echo "âœ… æ¸…ç†å˜æ›´å·²æäº¤åˆ° gh-pages åˆ†æ”¯"

      - name: å‘å¸ƒæ¸…ç†å®Œæˆé€šçŸ¥
        if: steps.cleanup.outputs.cleanup-performed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## ğŸ§¹ é¢„è§ˆç¯å¢ƒæ¸…ç†å®Œæˆ
            
            âœ… **æ¸…ç†çŠ¶æ€**: å·²æˆåŠŸæ¸…ç†
            
            ğŸ—‘ï¸ **æ¸…ç†å†…å®¹:**
            - é¢„è§ˆç›®å½•: \`pr-preview/pr-${{ github.event.pull_request.number }}\`
            - æ¸…ç†æ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
            
            ğŸ’¾ **æ¸…ç†è¯¦æƒ…:**
            - PR é¢„è§ˆç¯å¢ƒå·²ä» GitHub Pages ä¸­ç§»é™¤
            - ç›¸å…³é™æ€èµ„æºå·²æ¸…ç†å®Œæ¯•
            - ä¸å†å ç”¨å­˜å‚¨ç©ºé—´
            
            ğŸ‰ æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼
            
            ---
            *ğŸ¤– æ­¤é€šçŸ¥ç”±é¢„è§ˆæ¸…ç†å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: å‘å¸ƒæ— éœ€æ¸…ç†é€šçŸ¥
        if: steps.cleanup.outputs.cleanup-performed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## ğŸ§¹ é¢„è§ˆç¯å¢ƒæ¸…ç†çŠ¶æ€
            
            â„¹ï¸ **æ¸…ç†çŠ¶æ€**: æ— éœ€æ¸…ç†
            
            ğŸ“‹ **è¯´æ˜:**
            - æœ¬ PR æœªåˆ›å»ºé¢„è§ˆç¯å¢ƒï¼Œæˆ–å·²æå‰æ¸…ç†
            - å¯èƒ½åŸå› ï¼šæ–‡ä»¶å˜æ›´ä¸æ¶‰åŠæ–‡æ¡£å†…å®¹ï¼Œæ™ºèƒ½æ£€æµ‹è·³è¿‡äº†æ„å»º
            
            ğŸ‰ æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼
            
            ---
            *ğŸ¤– æ­¤é€šçŸ¥ç”±é¢„è§ˆæ¸…ç†å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });