# æ–‡ä»¶å: .github/workflows/pr-validation.yml
name: 'PR æ„å»ºä¸é¢„è§ˆéªŒè¯'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# ç”³è¯·éƒ¨ç½²åˆ° Pages æ‰€éœ€çš„æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-and-deploy-preview:
    name: 'æ„å»ºå¹¶éƒ¨ç½²é¢„è§ˆ'
    runs-on: ubuntu-latest
    
    # ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªç¯å¢ƒæ¥åœ¨ PR é¡µé¢æ˜¾ç¤ºé¢„è§ˆé“¾æ¥
    environment:
      name: pr-preview-${{ github.event.pull_request.number }}
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${{ github.event.pull_request.number }}/
      
    steps:
      # æ­¥éª¤ 1: æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹ (å¯é€‰ï¼Œå¦‚æœæƒ³æ¯æ¬¡éƒ½è·‘å¯ä»¥åˆ æ‰è¿™ä¸€æ­¥)
      - name: ğŸ” æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹
        id: changes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          build_patterns=("^docs/" "^mkdocs\.yml$" "^\.github/workflows/")
          should_build="false"
          for pattern in "${build_patterns[@]}"; do
            if [[ "$changed_files" =~ $pattern ]]; then
              should_build="true"
              break
            fi
          done
          echo "should-build=$should_build" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 2: æ„å»ºç½‘ç«™
      - name: ğŸ”¨ æ„å»ºé¢„è§ˆç½‘ç«™
        if: steps.changes.outputs.should-build == 'true'
        # æˆ‘ä»¬éœ€è¦é‡æ–° checkout PR çš„ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      # --- è¿™é‡Œæ˜¯ä½ æ‰€æœ‰çš„æ„å»ºå’ŒéªŒè¯æ­¥éª¤ ---
      - name: Set up Python
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install uv
        if: steps.changes.outputs.should-build == 'true'
        run: pipx install uv

      - name: Cache dependencies
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}-pr

      - name: Install dependencies
        if: steps.changes.outputs.should-build == 'true'
        run: uv sync

      - name: ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
        if: steps.changes.outputs.should-build == 'true'
        run: uv run mkdocs build --clean --strict --verbose
      
      # æ­¥éª¤ 3: éƒ¨ç½²åˆ° GitHub Pages (é¢„è§ˆç¯å¢ƒ)
      - name: ğŸŒ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        if: steps.changes.outputs.should-build == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/pr-${{ github.event.pull_request.number }}
          keep_files: false # æ¯æ¬¡éƒ½è¦†ç›–