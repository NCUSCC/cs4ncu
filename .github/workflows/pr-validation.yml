# æ–‡ä»¶å: .github/workflows/pr-validation.yml
name: 'PR æ„å»ºéªŒè¯'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# ç”³è¯·æœ€ä½æƒé™ï¼šåªéœ€è¯»å–ä»“åº“å†…å®¹å³å¯
permissions:
  contents: read

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-validation:
    name: 'ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯'
    runs-on: ubuntu-latest
      
    steps:
      # æ­¥éª¤ 1: æ‹‰å–ä»£ç 
      - name: ğŸšš æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 

      # æ­¥éª¤ 2: æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹ (å¯é€‰ï¼Œå¦‚æœæƒ³æ¯æ¬¡éƒ½è·‘å¯ä»¥åˆ æ‰è¿™ä¸€æ­¥)
      - name: ğŸ” æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹
        id: changes
        run: |
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...HEAD)
          build_patterns=("^docs/" "^mkdocs\.yml$" "^\.github/workflows/pr-validation\.yml$")
          echo "æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨:"
          echo "${changed_files}"
          should_build="false"
          while IFS= read -r file; do
            for pattern in "${build_patterns[@]}"; do
              if [[ "$file" =~ $pattern ]]; then
                echo "âœ… æ–‡ä»¶ '${file}' åŒ¹é…æ¨¡å¼ '${pattern}'ï¼Œéœ€è¦æ„å»ºã€‚"
                should_build="true"
                break 2
              fi
            done
          done <<< "${changed_files}"
          if [[ "$should_build" == "false" ]]; then
            echo "âŒ æœªæ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„å˜æ›´ï¼Œè·³è¿‡åç»­æ­¥éª¤ã€‚"
          fi
          echo "should-build=$should_build" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # æ­¥éª¤ 4: å®‰è£… uv å¹¶ç¼“å­˜ä¾èµ–
      - name: Install uv
        if: steps.changes.outputs.should-build == 'true'
        run: pipx install uv

      - name: Cache dependencies
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}-pr

      - name: Install dependencies
        if: steps.changes.outputs.should-build == 'true'
        run: uv sync

      # æ­¥éª¤ 5: æ ¸å¿ƒéªŒè¯æ­¥éª¤ - ä¸¥æ ¼æ¨¡å¼æ„å»º
      # è¿™ä¸€æ­¥ä¼šæ£€æŸ¥æ‰€æœ‰å†…éƒ¨é“¾æ¥ã€é…ç½®ç­‰æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœæ„å»ºå¤±è´¥ï¼Œå·¥ä½œæµä¼šå¤±è´¥ã€‚
      - name: ğŸ”¨ ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
        if: steps.changes.outputs.should-build == 'true'
        run: uv run mkdocs build --clean --strict --verbose