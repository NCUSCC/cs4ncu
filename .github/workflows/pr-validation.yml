# æ–‡ä»¶å: .github/workflows/pr-validation.yml
name: 'PR æ„å»ºéªŒè¯'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# ç”³è¯·æœ€ä½æƒé™ï¼šåªéœ€è¯»å–ä»“åº“å†…å®¹å³å¯
permissions:
  contents: read

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-validation:
    name: 'ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯'
    runs-on: ubuntu-latest
      
    steps:
      # æ­¥éª¤ 1: æ‹‰å–ä»£ç 
      - name: ğŸšš æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 

      # æ­¥éª¤ 2: æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹ (å¯é€‰ï¼Œå¦‚æœæƒ³æ¯æ¬¡éƒ½è·‘å¯ä»¥åˆ æ‰è¿™ä¸€æ­¥)
      - name: ğŸ” æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹
        id: changes
        run: |
          # æ³¨æ„ï¼šæˆ‘ä»¬å°† 'scripts/' ç›®å½•ä¹ŸåŠ å…¥åˆ°äº†æ£€æµ‹æ¨¡å¼ä¸­
          # è¿™æ ·ï¼Œå¦‚æœåªä¿®æ”¹äº† manage_tags.py è„šæœ¬æœ¬èº«ï¼ŒCI ä¹Ÿä¼šè¿è¡Œ
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...HEAD)
          build_patterns=("^docs/" "^mkdocs\.yml$" "^tools/" "^\.github/workflows/pr-validation\.yml$")
          echo "æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨:"
          echo "${changed_files}"
          should_build="false"
          while IFS= read -r file; do
            for pattern in "${build_patterns[@]}"; do
              if [[ "$file" =~ $pattern ]]; then
                echo "âœ… æ–‡ä»¶ '${file}' åŒ¹é…æ¨¡å¼ '${pattern}'ï¼Œéœ€è¦æ„å»ºã€‚"
                should_build="true"
                break 2
              fi
            done
          done <<< "${changed_files}"
          if [[ "$should_build" == "false" ]]; then
            echo "âŒ æœªæ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„å˜æ›´ï¼Œè·³è¿‡åç»­æ­¥éª¤ã€‚"
          fi
          echo "should-build=$should_build" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # æ­¥éª¤ 4: å®‰è£… uv å¹¶ç¼“å­˜ä¾èµ–
      - name: Install uv
        if: steps.changes.outputs.should-build == 'true'
        run: pipx install uv

      - name: Cache dependencies
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}-pr

      - name: Install dependencies
        if: steps.changes.outputs.should-build == 'true'
        # å‡è®¾ä½ çš„ä¾èµ–æ–‡ä»¶æ˜¯ requirements.txt
        run: uv sync
        # æ­¥éª¤ 4.5: æ ‡ç­¾è§„èŒƒæ€§æ£€æŸ¥
      - name: ğŸ·ï¸ æ ‡ç­¾è§„èŒƒæ€§æ£€æŸ¥
        if: steps.changes.outputs.should-build == 'true'
        # å¹¶ä¸”æˆ‘ä»¬ä½¿ç”¨ 'check' æ¨¡å¼ï¼Œå®ƒåœ¨å‘ç°é—®é¢˜æ—¶ä¼šä»¥éé›¶çŠ¶æ€ç é€€å‡ºï¼Œä»è€Œä½¿å·¥ä½œæµå¤±è´¥ã€‚
        run: uv run tools/manage_tags.py check

      # æ­¥éª¤ 5: æ ¸å¿ƒéªŒè¯æ­¥éª¤ - ä¸¥æ ¼æ¨¡å¼æ„å»º
      # åªæœ‰åœ¨ä¸Šé¢çš„æ ‡ç­¾æ£€æŸ¥é€šè¿‡åï¼Œè¿™ä¸€æ­¥æ‰ä¼šæ‰§è¡Œã€‚
      - name: ğŸ”¨ ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
        if: steps.changes.outputs.should-build == 'true'
        run: uv run mkdocs build --clean --strict --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
