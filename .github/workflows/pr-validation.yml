# æ–‡ä»¶å: .github/workflows/pr-validation.yml
name: 'PR æ„å»ºä¸é¢„è§ˆéªŒè¯'

on:
  pull_request:
    types: [opened, synchronize, reopened, closed] # å¢åŠ äº† closed ä»¥ä¾¿è§¦å‘æ¸…ç†
    branches: [main]

# ç”³è¯·éƒ¨ç½²åˆ° Pages æ‰€éœ€çš„æƒé™
permissions:
  contents: write # æ¸…ç†æ—¶éœ€è¦ write æƒé™æ¥æ¨é€ gh-pages åˆ†æ”¯
  pages: write
  id-token: write

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-and-deploy-preview:
    name: 'æ„å»ºå¹¶éƒ¨ç½²é¢„è§ˆ'
    # åªæœ‰åœ¨ PR ä¸æ˜¯è¢«å…³é—­æ—¶æ‰è¿è¡Œæ­¤ job
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    # åœ¨ PR é¡µé¢æ˜¾ç¤ºé¢„è§ˆé“¾æ¥
    environment:
      name: pr-preview-${{ github.event.pull_request.number }}
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${{ github.event.pull_request.number }}/
      
    steps:
      # æ­¥éª¤ 1: æ‹‰å–ä»£ç  (ä¸€æ¬¡æ€§å®Œæˆ)
      # æ‹‰å– PR çš„æœ€æ–°ä»£ç ï¼Œå¹¶è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿è¿›è¡Œ diff
      - name: ğŸšš æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 

      # æ­¥éª¤ 2: æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹ (å·²ä¿®æ­£é€»è¾‘)
      - name: ğŸ” æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹
        id: changes
        run: |
          # è·å–åŸºç¡€åˆ†æ”¯å’Œå½“å‰åˆ†æ”¯ä¹‹é—´çš„æ–‡ä»¶å·®å¼‚
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...HEAD)
          
          # å®šä¹‰éœ€è¦è§¦å‘æ„å»ºçš„æ–‡ä»¶/ç›®å½•æ¨¡å¼ (æ­£åˆ™è¡¨è¾¾å¼)
          # è§„åˆ™: docs ç›®å½•ï¼Œmkdocs.yml æ–‡ä»¶ï¼Œæˆ–æ­¤å·¥ä½œæµæ–‡ä»¶æœ¬èº«
          build_patterns=("^docs/" "^mkdocs\.yml$" "^\.github/workflows/pr-validation\.yml$")
          
          echo "æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨:"
          echo "${changed_files}"
          
          should_build="false"
          
          # é€è¡Œè¯»å–æ–‡ä»¶åˆ—è¡¨å¹¶ä¸æ¨¡å¼è¿›è¡ŒåŒ¹é…
          while IFS= read -r file; do
            for pattern in "${build_patterns[@]}"; do
              if [[ "$file" =~ $pattern ]]; then
                echo "âœ… æ–‡ä»¶ '${file}' åŒ¹é…æ¨¡å¼ '${pattern}'ï¼Œéœ€è¦æ„å»ºã€‚"
                should_build="true"
                break 2 # åŒ¹é…æˆåŠŸï¼Œè·³å‡ºå†…å¤–ä¸¤å±‚å¾ªç¯
              fi
            done
          done <<< "${changed_files}"
          
          if [[ "$should_build" == "false" ]]; then
            echo "âŒ æœªæ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„å˜æ›´ã€‚"
          fi

          echo "should-build=$should_build" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # æ­¥éª¤ 4: å®‰è£… uv å¹¶ç¼“å­˜ä¾èµ–
      - name: Install uv
        if: steps.changes.outputs.should-build == 'true'
        run: pipx install uv

      - name: Cache dependencies
        if: steps.changes.outputs.should-build == 'true'
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}-pr

      - name: Install dependencies
        if: steps.changes.outputs.should-build == 'true'
        run: uv sync

      # æ­¥éª¤ 5: ä¸¥æ ¼æ¨¡å¼æ„å»ºç½‘ç«™
      - name: ğŸ”¨ ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
        if: steps.changes.outputs.should-build == 'true'
        run: uv run mkdocs build --clean --strict --verbose
      
      # æ­¥éª¤ 6: éƒ¨ç½²åˆ° GitHub Pages (é¢„è§ˆç¯å¢ƒ)
      - name: ğŸŒ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        if: steps.changes.outputs.should-build == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/pr-${{ github.event.pull_request.number }}
          keep_files: false # æ¯æ¬¡éƒ½è¦†ç›–æ—§çš„é¢„è§ˆ
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'


  cleanup-preview:
    name: 'æ¸…ç†é¢„è§ˆç¯å¢ƒ'
    # ä»…åœ¨ PR è¢«å…³é—­ (closed) æˆ–åˆå¹¶ (merged) æ—¶è¿è¡Œ
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ—‘ï¸ åˆ é™¤é¢„è§ˆç›®å½•
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # é€šè¿‡å‘å¸ƒä¸€ä¸ªç©ºç›®å½•åˆ°ç›®æ ‡ä½ç½®æ¥å®ç°åˆ é™¤
          publish_dir: ./empty-dir-for-cleanup 
          destination_dir: pr-preview/pr-${{ github.event.pull_request.number }}
          keep_files: false
          allow_empty_commit: true # å¿…é¡»å…è®¸ç©ºæäº¤ä»¥è®°å½•åˆ é™¤æ“ä½œ
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          
      # åœ¨ peaceiris/actions-gh-pages è¿è¡Œå‰åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ç©ºç›®å½•
      - run: mkdir ./empty-dir-for-cleanup