# æ–‡ä»¶å: .github/workflows/pr-preview-build.yml

name: 'æ„å»º PR é¢„è§ˆç¯å¢ƒ'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read # åªè¯»æƒé™ï¼Œéå¸¸å®‰å…¨

concurrency:
  group: pr-preview-build-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # é˜¶æ®µä¸€ï¼šæ£€æµ‹æ–‡ä»¶å˜æ›´
  detect-changes:
    name: ğŸ” æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.changes.outputs.should-build }}
      changed-files: ${{ steps.changes.outputs.changed-files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # --- ä½ çš„æ–‡ä»¶å˜æ›´åˆ†æè„šæœ¬ï¼Œä¿æŒä¸å˜ ---
      - name: åˆ†ææ–‡ä»¶å˜æ›´
        id: changes
        run: |
          # (è¿™é‡Œæ˜¯ä½ åŸæ¥çš„å®Œæ•´åˆ†æè„šæœ¬ï¼Œæˆ‘çœç•¥äº†ä»¥ä¿æŒç®€æ´)
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          build_patterns=("^docs/" "^mkdocs\.yml$" "^\.github/workflows/")
          should_build="false"
          for pattern in "${build_patterns[@]}"; do
            if [[ "$changed_files" =~ $pattern ]]; then
              should_build="true"
              break
            fi
          done
          echo "should-build=$should_build" >> $GITHUB_OUTPUT

  # é˜¶æ®µäºŒï¼šæ„å»ºç½‘ç«™
  build:
    name: ğŸ”¨ æ„å»ºé¢„è§ˆç½‘ç«™
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # å…³é”®ï¼šæ˜ç¡®æ£€å‡º PR çš„ä»£ç è¿›è¡Œæ„å»º
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install uv
        run: pipx install uv

      - name: Cache uv virtual environment
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}-pr
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies with uv
        run: uv sync

      - name: ğŸ” ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
        run: uv run mkdocs build --clean --strict --verbose

      # å…³é”®æ­¥éª¤ï¼šå°†æ„å»ºå¥½çš„ `site` ç›®å½•ä½œä¸ºäº§ç‰©ä¸Šä¼ 
      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: preview-site-${{ github.event.pull_request.number }}
          path: ./site