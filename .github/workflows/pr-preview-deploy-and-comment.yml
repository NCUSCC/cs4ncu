# æ–‡ä»¶å: .github/workflows/pr-preview-deploy-and-comment.yml

name: 'éƒ¨ç½² PR é¢„è§ˆå¹¶è¯„è®º'

on:
  workflow_run:
    workflows: ["æ„å»º PR é¢„è§ˆç¯å¢ƒ"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  pages: write

jobs:
  get-pr-number:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
      should_deploy: ${{ steps.check-conclusion.outputs.should_deploy }}
    steps:
      - name: æ£€æŸ¥æ„å»ºç»“æœ
        id: check-conclusion
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
      - name: æŸ¥æ‰¾å…³è”çš„ PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const head_sha = "${{ github.event.workflow_run.head_sha }}";
            const { data: pull_requests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: head_sha,
            });
            if (pull_requests.length === 0) {
              core.setFailed(`åœ¨ commit SHA (${head_sha}) ä¸Šæ‰¾ä¸åˆ°å…³è”çš„ Pull Requestã€‚`);
              return;
            }
            const pr_number = pull_requests[0].number;
            core.setOutput('pr_number', pr_number);

  deploy-and-comment:
    runs-on: ubuntu-latest
    needs: get-pr-number
    # åªè¦æ‰¾åˆ°äº† PR å·å°±è¿è¡Œï¼Œåœ¨å†…éƒ¨æ ¹æ® should_deploy åˆ¤æ–­
    if: needs.get-pr-number.outputs.pr_number
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        if: needs.get-pr-number.outputs.should_deploy == 'true'
        uses: actions/download-artifact@v4
        with:
          name: preview-site-${{ needs.get-pr-number.outputs.pr_number }}
          path: ./site

      - name: ğŸŒ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        if: needs.get-pr-number.outputs.should_deploy == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/pr-${{ needs.get-pr-number.outputs.pr_number }}
          keep_files: false

      - name: ğŸ“ å‘è¡¨æˆ–æ›´æ–°è¯„è®º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = ${{ needs.get-pr-number.outputs.pr_number }};
            const should_deploy = "${{ needs.get-pr-number.outputs.should_deploy }}" === "true";
            const preview_url = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-preview/pr-${pr_number}/`;
            const logs_url = "${{ github.event.workflow_run.html_url }}";
            
            let commentBody = '';
            if (should_deploy) {
              commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€\n\nâœ… **æ„å»ºæˆåŠŸï¼**\n\nğŸŒ **é¢„è§ˆé“¾æ¥:** [æŸ¥çœ‹é¢„è§ˆç½‘ç«™](${preview_url})\n\n[æŸ¥çœ‹æ„å»ºæ—¥å¿—](${logs_url})`;
            } else {
              commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€\n\nâŒ **æ„å»ºå¤±è´¥**\n\nè¯·æ£€æŸ¥ [è¯¦ç»†é”™è¯¯æ—¥å¿—](${logs_url}) è·å–æ›´å¤šä¿¡æ¯ã€‚`;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: pr_number,
            });
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo, comment_id: existingComment.id, body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: pr_number, body: commentBody
              });
            }