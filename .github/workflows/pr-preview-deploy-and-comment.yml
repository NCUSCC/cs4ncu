# æ–‡ä»¶å: .github/workflows/pr-preview-deploy-and-comment.yml

name: 'éƒ¨ç½² PR é¢„è§ˆå¹¶è¯„è®º'

on:
  workflow_run:
    # å…³é”®ï¼šç›‘è§†ä¸Šé¢é‚£ä¸ªå·¥ä½œæµï¼åå­—å¿…é¡»å®Œå…¨åŒ¹é…ï¼
    workflows: ["æ„å»º PR é¢„è§ˆç¯å¢ƒ"]
    types:
      - completed

# å…³é”®ï¼šè¿™é‡Œç”³è¯·æ‰€æœ‰éœ€è¦çš„å†™å…¥æƒé™
permissions:
  contents: write
  pull-requests: write
  pages: write

jobs:
  deploy-and-comment:
    runs-on: ubuntu-latest
    # ç¡®ä¿åªå¯¹ PR è§¦å‘çš„æ„å»ºè¿›è¡Œæ“ä½œ
    if: github.event.workflow_run.event == 'pull_request'

    steps:
      # æ­¥éª¤ 1: æ ¹æ®æ„å»ºç»“æœè¿›è¡Œæ“ä½œ
      - name: ğŸ“ å¤„ç†æ„å»ºç»“æœ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ä»äº‹ä»¶è½½è·ä¸­å®‰å…¨åœ°è·å– PR ä¿¡æ¯
            const pr = ${{ toJSON(github.event.workflow_run.pull_requests[0]) }};
            const pr_number = pr.number;
            const conclusion = "${{ github.event.workflow_run.conclusion }}";
            const repo_full_name = "${{ github.repository }}";
            const [owner, repo] = repo_full_name.split('/');
            const preview_url = `https://${owner}.github.io/${repo}/pr-preview/pr-${pr_number}/`;
            const logs_url = "${{ github.event.workflow_run.html_url }}";
            
            let commentBody = '';

            if (conclusion === 'success') {
              // æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœæ„å»ºè¢«è·³è¿‡ï¼Œäº§ç‰©å°±ä¸ä¼šå­˜åœ¨ã€‚
              // (æ³¨æ„ï¼šæ­¤è„šæœ¬æ— æ³•ç›´æ¥æ£€æŸ¥äº§ç‰©ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡åç»­æ­¥éª¤æ˜¯å¦æˆåŠŸæ¥åˆ¤æ–­)
              // è¿™é‡Œæˆ‘ä»¬å…ˆä¹è§‚åœ°ç”ŸæˆæˆåŠŸæ¶ˆæ¯ï¼Œå¦‚æœåç»­éƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥æ›´æ–°è¯„è®º
              commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€\n\nâœ… **æ„å»ºæˆåŠŸï¼**\n\nğŸŒ **é¢„è§ˆé“¾æ¥:** [æŸ¥çœ‹é¢„è§ˆç½‘ç«™](${preview_url})\n\n[æŸ¥çœ‹æ„å»ºæ—¥å¿—](${logs_url})`;
              
              // æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œè¡¨ç¤ºéœ€è¦éƒ¨ç½²
              core.setOutput('should_deploy', 'true');

            } else { // failure, cancelled, etc.
              commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€\n\nâŒ **æ„å»ºå¤±è´¥**\n\nè¯·æ£€æŸ¥ [è¯¦ç»†é”™è¯¯æ—¥å¿—](${logs_url}) è·å–æ›´å¤šä¿¡æ¯ã€‚`;
              core.setOutput('should_deploy', 'false');
            }

            // --- æŸ¥æ‰¾å¹¶æ›´æ–°æˆ–åˆ›å»ºè¯„è®º ---
            const { data: comments } = await github.rest.issues.listComments({
              owner: owner, repo: repo, issue_number: pr_number,
            });
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: owner, repo: repo, comment_id: existingComment.id, body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: owner, repo: repo, issue_number: pr_number, body: commentBody
              });
            }
        id: handle-result # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ª IDï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¯ä»¥å¼•ç”¨å®ƒçš„è¾“å‡º

      # æ­¥éª¤ 2: ä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆå¦‚æœéœ€è¦éƒ¨ç½²ï¼‰
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        if: steps.handle-result.outputs.should_deploy == 'true'
        uses: actions/download-artifact@v4
        with:
          name: preview-site-${{ github.event.workflow_run.pull_requests[0].number }}
          path: ./site

      # æ­¥éª¤ 3: éƒ¨ç½²åˆ° GitHub Pagesï¼ˆå¦‚æœéœ€è¦éƒ¨ç½²ï¼‰
      - name: ğŸŒ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        if: steps.handle-result.outputs.should_deploy == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/pr-${{ github.event.workflow_run.pull_requests[0].number }}
          keep_files: false # æ¯æ¬¡éƒ½æ˜¯å…¨æ–°éƒ¨ç½²ï¼Œä¸ä¿ç•™æ—§æ–‡ä»¶