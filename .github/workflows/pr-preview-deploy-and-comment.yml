# 文件名: .github/workflows/pr-preview-deploy-and-comment.yml

name: '部署 PR 预览并评论'

on:
  workflow_run:
    workflows: ["构建 PR 预览环境"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  pages: write

jobs:
  get-pr-number:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
      should_deploy: ${{ steps.check-conclusion.outputs.should_deploy }}
    steps:
      - name: 检查构建结果
        id: check-conclusion
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
      - name: 查找关联的 PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const head_sha = "${{ github.event.workflow_run.head_sha }}";
            const { data: pull_requests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: head_sha,
            });
            if (pull_requests.length === 0) {
              core.setFailed(`在 commit SHA (${head_sha}) 上找不到关联的 Pull Request。`);
              return;
            }
            const pr_number = pull_requests[0].number;
            core.setOutput('pr_number', pr_number);

  deploy-and-comment:
    runs-on: ubuntu-latest
    needs: get-pr-number
    # 只要找到了 PR 号就运行，在内部根据 should_deploy 判断
    if: needs.get-pr-number.outputs.pr_number
    steps:
      - name: 📥 下载构建产物
        if: needs.get-pr-number.outputs.should_deploy == 'true'
        uses: actions/download-artifact@v4
        with:
          name: preview-site-${{ needs.get-pr-number.outputs.pr_number }}
          path: ./site

      - name: 🌐 部署预览环境
        if: needs.get-pr-number.outputs.should_deploy == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/pr-${{ needs.get-pr-number.outputs.pr_number }}
          keep_files: false

      - name: 📝 发表或更新评论
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = ${{ needs.get-pr-number.outputs.pr_number }};
            const should_deploy = "${{ needs.get-pr-number.outputs.should_deploy }}" === "true";
            const preview_url = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-preview/pr-${pr_number}/`;
            const logs_url = "${{ github.event.workflow_run.html_url }}";
            
            let commentBody = '';
            if (should_deploy) {
              commentBody = `## 📋 PR 预览构建状态\n\n✅ **构建成功！**\n\n🌐 **预览链接:** [查看预览网站](${preview_url})\n\n[查看构建日志](${logs_url})`;
            } else {
              commentBody = `## 📋 PR 预览构建状态\n\n❌ **构建失败**\n\n请检查 [详细错误日志](${logs_url}) 获取更多信息。`;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: pr_number,
            });
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('📋 PR 预览构建状态')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo, comment_id: existingComment.id, body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: pr_number, body: commentBody
              });
            }