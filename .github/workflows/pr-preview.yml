# æ™ºèƒ½ PR éªŒè¯å·¥ä½œæµ
name: ğŸ“‹ æ™ºèƒ½ PR éªŒè¯ä¸é¢„è§ˆ

# è§¦å‘æ¡ä»¶ï¼šPR åˆ›å»ºã€æ›´æ–°ã€é‡æ–°æ‰“å¼€
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# æƒé™é…ç½®
permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€ PR çš„å¤šæ¬¡æ¨é€åªä¿ç•™æœ€æ–°çš„
concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæ™ºèƒ½æ–‡ä»¶æ£€æµ‹
  detect-changes:
    name: ğŸ” æ™ºèƒ½æ–‡ä»¶å˜æ›´æ£€æµ‹
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.changes.outputs.should-build }}
      changed-files: ${{ steps.changes.outputs.changed-files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: åˆ†ææ–‡ä»¶å˜æ›´
        id: changes
        run: |
          echo "ğŸ” å¼€å§‹åˆ†ææ–‡ä»¶å˜æ›´..."
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }})
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼š"
          echo "$changed_files"
          
          # å®šä¹‰éœ€è¦è§¦å‘æ„å»ºçš„æ–‡ä»¶æ¨¡å¼
          build_patterns=(
            "^docs/"
            "^mkdocs\.yml$"
            "^pyproject\.toml$"
            "^overrides/"
            "^\.github/workflows/"
            "^README\.md$"
          )
          
          # å®šä¹‰è·³è¿‡æ„å»ºçš„æ–‡ä»¶æ¨¡å¼  
          skip_patterns=(
            "^class0/"
            "^main\.py$"
            "^drafts/"
            "^\.gitignore$"
            "^\.mailmap$"
            "^\.markdownlint\.yaml$"
            "^\.python-version$"
            "^uv\.lock$"
            "^issues/"
          )
          
          should_build="false"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶åŒ¹é…æ„å»ºæ¨¡å¼
          while IFS= read -r file; do
            if [[ -z "$file" ]]; then
              continue
            fi
            
            # é¦–å…ˆæ£€æŸ¥æ˜¯å¦åœ¨è·³è¿‡åˆ—è¡¨ä¸­
            skip_file="false"
            for pattern in "${skip_patterns[@]}"; do
              if [[ $file =~ $pattern ]]; then
                echo "â­ï¸  è·³è¿‡æ–‡ä»¶: $file (åŒ¹é…è·³è¿‡æ¨¡å¼: $pattern)"
                skip_file="true"
                break
              fi
            done
            
            # å¦‚æœä¸åœ¨è·³è¿‡åˆ—è¡¨ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
            if [[ $skip_file == "false" ]]; then
              for pattern in "${build_patterns[@]}"; do
                if [[ $file =~ $pattern ]]; then
                  echo "âœ… è§¦å‘æ„å»º: $file (åŒ¹é…æ„å»ºæ¨¡å¼: $pattern)"
                  should_build="true"
                  break 2
                fi
              done
              
              # å¦‚æœæ–‡ä»¶ä¸åŒ¹é…ä»»ä½•å·²çŸ¥æ¨¡å¼ï¼Œé»˜è®¤è§¦å‘æ„å»ºï¼ˆå®‰å…¨ç­–ç•¥ï¼‰
              echo "â“ æœªçŸ¥æ–‡ä»¶ç±»å‹ï¼Œå®‰å…¨èµ·è§è§¦å‘æ„å»º: $file"
              should_build="true"
              break
            fi
          done <<< "$changed_files"
          
          echo "should-build=$should_build" >> $GITHUB_OUTPUT
          
          if [[ $should_build == "true" ]]; then
            echo "ğŸš€ æ£€æµ‹ç»“æœ: éœ€è¦æ„å»ºæ–‡æ¡£"
          else
            echo "â­ï¸  æ£€æµ‹ç»“æœ: è·³è¿‡æ–‡æ¡£æ„å»º"
          fi

  # ç¬¬äºŒé˜¶æ®µï¼šPR çŠ¶æ€é€šçŸ¥ï¼ˆå¼€å§‹æ„å»ºï¼‰
  notify-start:
    name: ğŸ’¬ é€šçŸ¥æ„å»ºå¼€å§‹
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'true'
    steps:
      - name: å‘å¸ƒå¼€å§‹æ„å»ºè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ„å»ºçŠ¶æ€è¯„è®º
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€')
            );
            
            const commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€
            
            ğŸ”„ **æ­£åœ¨æ„å»ºä¸­...**
            
            ğŸ“ **æ£€æµ‹åˆ°çš„ç›¸å…³æ–‡ä»¶å˜æ›´:**
            \`\`\`
            ${{ needs.detect-changes.outputs.changed-files }}
            \`\`\`
            
            â³ è¯·ç¨å€™ï¼Œæ–‡æ¡£æ­£åœ¨æ„å»ºå’Œéƒ¨ç½²ä¸­...
            
            ---
            *ğŸ¤– æ­¤è¯„è®ºç”±æ™ºèƒ½ PR éªŒè¯å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  # ç¬¬ä¸‰é˜¶æ®µï¼šä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
  build-and-preview:
    name: ğŸ”¨ ä¸¥æ ¼æ„å»ºä¸é¢„è§ˆéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [detect-changes, notify-start]
    if: needs.detect-changes.outputs.should-build == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install uv
        run: pipx install uv

      - name: Cache uv virtual environment
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}-pr
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies with uv
        run: uv sync

      - name: ğŸ” ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯
        run: |
          echo "ğŸ”¨ å¼€å§‹ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯..."
          
          # ä½¿ç”¨ --strict æ¨¡å¼ç¡®ä¿æ²¡æœ‰è­¦å‘Š
          # ä½¿ç”¨ --clean ç¡®ä¿å¹²å‡€æ„å»º
          uv run mkdocs build --clean --strict --verbose
          
          echo "âœ… ä¸¥æ ¼æ¨¡å¼æ„å»ºéªŒè¯é€šè¿‡"

      - name: ğŸ“Š æ„å»ºè´¨é‡æ£€æŸ¥
        run: |
          echo "ğŸ“Š æ‰§è¡Œæ„å»ºè´¨é‡æ£€æŸ¥..."
          
          # æ£€æŸ¥ç”Ÿæˆçš„ç½‘ç«™ç›®å½•
          if [[ ! -d "site" ]]; then
            echo "âŒ é”™è¯¯: site ç›®å½•æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          required_files=("site/index.html" "site/sitemap.xml")
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ é”™è¯¯: å¿…è¦æ–‡ä»¶ $file æœªç”Ÿæˆ"
              exit 1
            fi
          done
          
          # ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡
          total_files=$(find site -type f | wc -l)
          html_files=$(find site -name "*.html" | wc -l)
          
          echo "ğŸ“ˆ æ„å»ºç»Ÿè®¡:"
          echo "  - æ€»æ–‡ä»¶æ•°: $total_files"
          echo "  - HTMLæ–‡ä»¶æ•°: $html_files"
          
          if [[ $html_files -lt 5 ]]; then
            echo "âš ï¸  è­¦å‘Š: HTMLæ–‡ä»¶æ•°é‡ä¼¼ä¹åå°‘ï¼Œè¯·æ£€æŸ¥æ„å»ºé…ç½®"
          fi
          
          echo "âœ… æ„å»ºè´¨é‡æ£€æŸ¥é€šè¿‡"

      - name: ğŸŒ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ  
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          destination_dir: pr-preview/pr-${{ github.event.pull_request.number }}
          keep_files: false

  # ç¬¬å››é˜¶æ®µï¼šæ„å»ºæˆåŠŸé€šçŸ¥
  notify-success:
    name: âœ… é€šçŸ¥æ„å»ºæˆåŠŸ
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-preview]
    if: needs.detect-changes.outputs.should-build == 'true' && success()
    steps:
      - name: å‘å¸ƒæ„å»ºæˆåŠŸè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€')
            );
            
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${{ github.event.pull_request.number }}/`;
            
            const commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€
            
            âœ… **æ„å»ºæˆåŠŸï¼**
            
            ğŸŒ **é¢„è§ˆé“¾æ¥:** [æŸ¥çœ‹é¢„è§ˆç½‘ç«™](${previewUrl})
            
            ğŸ“ **å¤„ç†çš„æ–‡ä»¶å˜æ›´:**
            \`\`\`
            ${{ needs.detect-changes.outputs.changed-files }}
            \`\`\`
            
            ğŸ‰ æ­å–œï¼æ‚¨çš„æ–‡æ¡£å˜æ›´å·²æˆåŠŸæ„å»ºå¹¶éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒã€‚
            
            ---
            *ğŸ¤– æ­¤è¯„è®ºç”±æ™ºèƒ½ PR éªŒè¯å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  # ç¬¬äº”é˜¶æ®µï¼šæ„å»ºå¤±è´¥é€šçŸ¥
  notify-failure:
    name: âŒ é€šçŸ¥æ„å»ºå¤±è´¥
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-preview]
    if: needs.detect-changes.outputs.should-build == 'true' && failure()
    steps:
      - name: å‘å¸ƒæ„å»ºå¤±è´¥è¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€')
            );
            
            const workflowUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€
            
            âŒ **æ„å»ºå¤±è´¥**
            
            ğŸ“ **å°è¯•å¤„ç†çš„æ–‡ä»¶å˜æ›´:**
            \`\`\`
            ${{ needs.detect-changes.outputs.changed-files }}
            \`\`\`
            
            ğŸ”§ **é—®é¢˜æ’æŸ¥:**
            - è¯·æ£€æŸ¥æ‚¨çš„ Markdown è¯­æ³•æ˜¯å¦æ­£ç¡®
            - è¯·ç¡®è®¤æ‰€æœ‰é“¾æ¥å’Œå›¾ç‰‡è·¯å¾„æœ‰æ•ˆ
            - è¯·æŸ¥çœ‹ [è¯¦ç»†é”™è¯¯æ—¥å¿—](${workflowUrl}) è·å–æ›´å¤šä¿¡æ¯
            
            ğŸ’¡ **æç¤º:** æ‚¨å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œ \`uv run mkdocs build --strict\` æ¥é‡ç°å¹¶ä¿®å¤é—®é¢˜ã€‚
            
            ---
            *ğŸ¤– æ­¤è¯„è®ºç”±æ™ºèƒ½ PR éªŒè¯å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  # ç¬¬å…­é˜¶æ®µï¼šè·³è¿‡æ„å»ºé€šçŸ¥
  notify-skipped:
    name: â­ï¸ é€šçŸ¥è·³è¿‡æ„å»º
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'false'
    steps:
      - name: å‘å¸ƒè·³è¿‡æ„å»ºè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€')
            );
            
            const commentBody = `## ğŸ“‹ PR é¢„è§ˆæ„å»ºçŠ¶æ€
            
            â­ï¸ **æ™ºèƒ½è·³è¿‡æ„å»º**
            
            ğŸ“ **æ£€æµ‹åˆ°çš„æ–‡ä»¶å˜æ›´:**
            \`\`\`
            ${{ needs.detect-changes.outputs.changed-files }}
            \`\`\`
            
            ğŸ¯ **è·³è¿‡åŸå› :** æœ¬æ¬¡å˜æ›´ä¸æ¶‰åŠæ–‡æ¡£ç›¸å…³æ–‡ä»¶ï¼Œæ— éœ€æ„å»ºé¢„è§ˆã€‚
            
            ğŸ“‹ **ä¼šè§¦å‘æ„å»ºçš„æ–‡ä»¶ç±»å‹:**
            - \`docs/\` ç›®å½•ä¸‹çš„æ–‡æ¡£æ–‡ä»¶
            - \`mkdocs.yml\` é…ç½®æ–‡ä»¶  
            - \`pyproject.toml\` ä¾èµ–é…ç½®
            - \`overrides/\` ä¸»é¢˜è¦†ç›–æ–‡ä»¶
            - \`.github/workflows/\` å·¥ä½œæµæ–‡ä»¶
            - \`README.md\` é¦–é¡µæ–‡æ¡£
            
            ---
            *ğŸ¤– æ­¤è¯„è®ºç”±æ™ºèƒ½ PR éªŒè¯å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }